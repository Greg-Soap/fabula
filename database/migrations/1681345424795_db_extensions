import { BaseSchema } from "@adonisjs/lucid/schema";

export default class extends BaseSchema {
	public async up() {
		this.schema.raw('CREATE EXTENSION IF NOT EXISTS "uuid-ossp"');
		this.schema.raw('CREATE EXTENSION IF NOT EXISTS "pgcrypto";');
		// pg_trgm and fuzzystrmatch omitted â€“ not available on all hosts (e.g. Railway)

		this.schema.raw(`CREATE OR REPLACE FUNCTION nanoid(size int DEFAULT 12, alphabet text DEFAULT '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')
            RETURNS text
            LANGUAGE plpgsql volatile
        AS
        $$
        DECLARE
            idBuilder     text := '';
            i             int  := 0;
            bytes         bytea;
            alphabetIndex int;
            mask          int;
            step          int;
        BEGIN
            mask := (2 << cast(floor(log(length(alphabet) - 1) / log(2)) as int)) - 1;
            step := cast(ceil(1.6 * mask * size / length(alphabet)) AS int);

            while true
                loop
                    bytes := gen_random_bytes(size);
                    while i < size
                        loop
                            alphabetIndex := (get_byte(bytes, i) & mask) + 1;
                            if alphabetIndex <= length(alphabet) then
                                idBuilder := idBuilder || substr(alphabet, alphabetIndex, 1);
                                if length(idBuilder) = size then
                                    return idBuilder;
                                end if;
                            end if;
                            i = i + 1;
                        end loop;

                    i := 0;
                end loop;
            END
        $$;`);
	}

	public async down() {
		this.schema.raw('DROP EXTENSION IF EXISTS "uuid-ossp"');
		this.schema.raw('DROP EXTENSION IF EXISTS "pgcrypto";');
	}
}
